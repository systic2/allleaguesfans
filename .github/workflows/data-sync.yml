# .github/workflows/data-sync.yml
name: API Football Data Sync (Optimized Schedule)

# API-Football ê¶Œì¥ í˜¸ì¶œ ì£¼ê¸°ì— ë”°ë¥¸ ìµœì í™”ëœ ìŠ¤ì¼€ì¤„:
# 
# ğŸ“Š ì¼ë°˜ ë°ì´í„° (1 call per day):
#   - Fixtures (non-live), Top scorers/assists, Team statistics, Standings
#   - ë§¤ì¼ 02:00 UTC (11:00 KST) ì‹¤í–‰
#
# âš¡ ë¼ì´ë¸Œ ë°ì´í„° (1 call per minute for ongoing fixtures):
#   - Live fixtures/events, Live player statistics
#   - ìˆ˜ìš”ì¼/í† ìš”ì¼ 18:00 KST (ê²½ê¸° ì‹œê°„ëŒ€) ì‹¤í–‰
#
# ğŸŸï¸ ë¼ì´ë¸Œ ë¼ì¸ì—… (every 15 minutes for ongoing fixtures):
#   - Live lineups (ê²½ê¸° 20-40ë¶„ ì „ë¶€í„° ì œê³µ)
#
# ğŸ‘¥ ì„ ìˆ˜ íŒ€ ì´ë ¥ (1 call per week):
#   - Player teams history
#   - ë§¤ì£¼ ì›”ìš”ì¼ 03:00 UTC ì‹¤í–‰
#
# ğŸš‘ ë¶€ìƒì ì •ë³´ (1 call per day, updated every 4 hours):
#   - Injuries/sidelined players
#   - ì¼ì¼ ë™ê¸°í™”ì— í¬í•¨

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC) - í•œêµ­ì‹œê°„ ì˜¤ì „ 11ì‹œ (ê²½ê¸° ê²°ê³¼, ìˆœìœ„í‘œ, ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸)
    # API-Football ê¶Œì¥: 1 call per day for non-live data
    - cron: '0 2 * * *'
    
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 3ì‹œ (ì „ì²´ ë°ì´í„° ì¬ë™ê¸°í™” + ì„ ìˆ˜ íŒ€ ì´ë ¥)
    # API-Football ê¶Œì¥: Player teams - 1 call per week
    - cron: '0 3 * * 1'
    
    # ë§¤ì£¼ ìˆ˜ìš”ì¼/í† ìš”ì¼ ì˜¤í›„ 6ì‹œ (KST) - ê²½ê¸° ì‹œê°„ëŒ€ ë¼ì´ë¸Œ ì—…ë°ì´íŠ¸
    # API-Football ê¶Œì¥: Live fixtures - 1 call per minute during matches
    - cron: '0 9 * * 3,6'  # UTC 9ì‹œ = KST 18ì‹œ
    
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Environment Check
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸ” Checking environment configuration..."
        npx tsx scripts/env-check.ts
      
    - name: Daily Data Sync (Non-Live)
      if: github.event.schedule == '0 2 * * *'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ Starting daily data sync (API-Football recommended: 1 call per day)..."
        echo "Environment check:"
        echo "SUPABASE_URL: $([[ -n "$SUPABASE_URL" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "SUPABASE_SERVICE_ROLE: $([[ -n "$SUPABASE_SERVICE_ROLE" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "API_FOOTBALL_KEY: $([[ -n "$API_FOOTBALL_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        
        # API-Football ê¶Œì¥ ì£¼ê¸°ì— ë”°ë¥¸ ë°ì´í„° ì—…ë°ì´íŠ¸
        # - Fixtures (non-live): 1 call per day
        # - Top scorers/assists: 1 call per day (updated several times a week)
        # - Team statistics: 1 call per day
        # - Standings: 1 call per day
        if npx tsx scripts/master-import-complete.ts; then
          echo "âœ… Master import completed successfully"
        else
          echo "âŒ Master import failed"
          exit 1
        fi
        
        # ì˜ˆì • ê²½ê¸° ì—…ë°ì´íŠ¸ (TBD, NS ìƒíƒœ) - API-Football ê¶Œì¥: 1 call per day
        if npx tsx scripts/import-upcoming-fixtures.ts; then
          echo "âœ… Upcoming fixtures import completed"
        else
          echo "âš ï¸ Upcoming fixtures import failed (non-critical)"
        fi
        
    - name: Live Match Updates
      if: github.event.schedule == '0 9 * * 3,6'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "âš¡ Starting live match updates (API-Football recommended: 1 call per minute for live fixtures)..."
        echo "Environment check:"
        echo "SUPABASE_URL: $([[ -n "$SUPABASE_URL" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "SUPABASE_SERVICE_ROLE: $([[ -n "$SUPABASE_SERVICE_ROLE" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "API_FOOTBALL_KEY: $([[ -n "$API_FOOTBALL_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        
        # ë¼ì´ë¸Œ ê²½ê¸° ë°ì´í„° ì—…ë°ì´íŠ¸ (ê²½ê¸° ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ)
        # - Live fixtures/events: 1 call per minute for ongoing fixtures
        # - Live lineups: every 15 minutes for ongoing fixtures  
        # - Live player statistics: every minute for ongoing fixtures
        if npx tsx scripts/import-live-matches.ts; then
          echo "âœ… Live match updates completed"
        else
          echo "âš ï¸ Live match updates failed (non-critical - no live matches may be ongoing)"
        fi
        
    - name: Weekly Full Sync & Player Teams
      if: github.event.schedule == '0 3 * * 1'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ Starting weekly full sync + player teams (API-Football recommended: 1 call per week for player teams)..."
        echo "Environment check:"
        echo "SUPABASE_URL: $([[ -n "$SUPABASE_URL" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "SUPABASE_SERVICE_ROLE: $([[ -n "$SUPABASE_SERVICE_ROLE" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "API_FOOTBALL_KEY: $([[ -n "$API_FOOTBALL_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        
        # ì „ì²´ ë°ì´í„° ì¬ê²€ì¦ ë° ë™ê¸°í™”
        if npx tsx scripts/master-import-complete.ts; then
          echo "âœ… Master import completed successfully"
        else
          echo "âŒ Master import failed"
          exit 1
        fi
        
        # ì„ ìˆ˜ íŒ€ ì´ë ¥ ì—…ë°ì´íŠ¸ - API-Football ê¶Œì¥: 1 call per week
        if npx tsx scripts/import-player-teams.ts; then
          echo "âœ… Player teams import completed"
        else
          echo "âš ï¸ Player teams import failed (non-critical)"
        fi
        
        # ì˜ˆì • ê²½ê¸° ì—…ë°ì´íŠ¸
        if npx tsx scripts/import-upcoming-fixtures.ts; then
          echo "âœ… Upcoming fixtures import completed"
        else
          echo "âš ï¸ Upcoming fixtures import failed (non-critical)"
        fi
        
    - name: Manual Full Sync (All Data Types)
      if: github.event_name == 'workflow_dispatch'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ Starting manual full sync (all data types)..."
        echo "Environment check:"
        echo "SUPABASE_URL: $([[ -n "$SUPABASE_URL" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "SUPABASE_SERVICE_ROLE: $([[ -n "$SUPABASE_SERVICE_ROLE" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "API_FOOTBALL_KEY: $([[ -n "$API_FOOTBALL_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        
        # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ëª¨ë“  ë°ì´í„° íƒ€ì… ë™ê¸°í™” (API-Football ê¶Œì¥ ì£¼ê¸° ë¬´ì‹œí•˜ê³  ì¦‰ì‹œ ì‹¤í–‰)
        if npx tsx scripts/master-import-complete.ts; then
          echo "âœ… Master import completed successfully"
        else
          echo "âŒ Master import failed"
          exit 1
        fi
        
        # ì„ ìˆ˜ íŒ€ ì´ë ¥ ì—…ë°ì´íŠ¸ (ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ)
        if npx tsx scripts/import-player-teams.ts; then
          echo "âœ… Player teams import completed"
        else
          echo "âš ï¸ Player teams import failed (non-critical)"
        fi
        
        # ë¼ì´ë¸Œ ê²½ê¸° ì²´í¬ ë° ì—…ë°ì´íŠ¸ (ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ)
        if npx tsx scripts/import-live-matches.ts; then
          echo "âœ… Live match check completed"
        else
          echo "âš ï¸ Live match check failed (non-critical)"
        fi
        
        # ì˜ˆì • ê²½ê¸° ì—…ë°ì´íŠ¸
        if npx tsx scripts/import-upcoming-fixtures.ts; then
          echo "âœ… Upcoming fixtures import completed"
        else
          echo "âš ï¸ Upcoming fixtures import failed (non-critical)"
        fi
        
    - name: Data Quality Check
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        NODE_ENV: production
      run: |
        echo "ğŸ” Starting data quality check..."
        echo "Environment check:"
        echo "SUPABASE_URL: $([[ -n "$SUPABASE_URL" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "SUPABASE_SERVICE_ROLE: $([[ -n "$SUPABASE_SERVICE_ROLE" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        
        # ë°ì´í„° í’ˆì§ˆ ê²€ì¦ (ìƒˆ ìŠ¤í‚¤ë§ˆ ê¸°ë°˜)
        if npx tsx scripts/final-verification.ts; then
          echo "âœ… Data quality check passed"
        else
          echo "âš ï¸ Data quality check failed (non-critical, will continue)"
        fi
        
    - name: Workflow Summary
      if: always()
      run: |
        echo "ğŸ‰ Data Sync Workflow Completed"
        echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "Trigger: ${{ github.event_name }}"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
