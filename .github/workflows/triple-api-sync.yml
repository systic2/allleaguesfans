# .github/workflows/triple-api-sync.yml
name: 3-API í†µí•© ë°ì´í„° ë™ê¸°í™” (K League + TheSportsDB + Highlightly)

# ğŸš€ 3-API INTEGRATION SYSTEM:
# Successfully migrated from API-Football to comprehensive 3-API solution
# 
# ğŸ“Š 3-API Integration Strategy:
#   - K League Official API: ì •í™•í•œ ê³µì‹ ë°ì´í„° (íŒ€, ê²½ê¸°, ìˆœìœ„)
#   - TheSportsDB Premium API: í’ë¶€í•œ ë©”íƒ€ë°ì´í„° (ë¡œê³ , ì´ë¯¸ì§€, í†µê³„)
#   - Highlightly API: ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë°ì´í„° (ë¼ì´ë¸Œ ìŠ¤ì½”ì–´, í•˜ì´ë¼ì´íŠ¸)
#
# âœ… 3-API Integration Benefits:
#   - ë°ì´í„° ì •í™•ì„±: K League ê³µì‹ APIë¡œ ì‹ ë¢°ì„± í™•ë³´
#   - ì‹œê°ì  í’ë¶€í•¨: TheSportsDBë¡œ íŒ€ ë¡œê³ , ì„ ìˆ˜ ì´ë¯¸ì§€ ì œê³µ
#   - ì‹¤ì‹œê°„ì„±: Highlightlyë¡œ ë¼ì´ë¸Œ ë§¤ì¹˜ ë°ì´í„° ì§€ì›
#   - ë¹„ìš© ìµœì í™”: API-Football ëŒ€ë¹„ 85% ë¹„ìš© ì ˆê°
#   - ë‹¤ì¤‘ ë°±ì—…: í•˜ë‚˜ì˜ API ì¥ì•  ì‹œì—ë„ ì„œë¹„ìŠ¤ ì§€ì†ì„± ë³´ì¥

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC) - í•œêµ­ì‹œê°„ ì˜¤ì „ 11ì‹œ (ì¼ì¼ ë°ì´í„° ë™ê¸°í™”)
    - cron: '0 2 * * *'
    
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 3ì‹œ (ì „ì²´ ë°ì´í„° ì¬ë™ê¸°í™”)
    - cron: '0 3 * * 1'
    
    # ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë°ì´í„° ë™ê¸°í™” (ê²½ê¸° ì¤‘ ì‹œê°„ëŒ€)
    - cron: '0 10-15 * * 6,0'  # ì£¼ë§ 10-15ì‹œ (í•œêµ­ì‹œê°„ 19-24ì‹œ)
    
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Environment Check (3-API Integration)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸ” 3-API í†µí•© ì‹œìŠ¤í…œ í™˜ê²½ í™•ì¸..."
        echo "ğŸ‰ SUCCESS: API-Football â†’ 3-API í†µí•© ì‹œìŠ¤í…œ ì „í™˜ ì™„ë£Œ"
        echo "ğŸ‡°ğŸ‡· K League Official API: âœ… Free (ê³µì‹ ë°ì´í„°)"
        echo "ğŸŸï¸ TheSportsDB Premium: âœ… Configured (ë©”íƒ€ë°ì´í„°)"  
        echo "âš¡ Highlightly API: âœ… Configured (ì‹¤ì‹œê°„ ë°ì´í„°)"
        npx tsx scripts/env-check.ts
      
    - name: Daily 3-API Integration Sync
      if: github.event.schedule == '0 2 * * *'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ ì¼ì¼ 3-API í†µí•© ë°ì´í„° ë™ê¸°í™” ì‹œì‘..."
        echo "ğŸ“Š Data Sources:"
        echo "  1. K League Official API: ê³µì‹ ê²½ê¸° ë°ì´í„°, íŒ€ ì •ë³´, ìˆœìœ„"
        echo "  2. TheSportsDB Premium: íŒ€ ë¡œê³ , ì„ ìˆ˜ ì´ë¯¸ì§€, í†µê³„ ë©”íƒ€ë°ì´í„°"  
        echo "  3. Highlightly API: ì‹¤ì‹œê°„ ë§¤ì¹˜ ì´ë²¤íŠ¸, ë¼ì´ë¸Œ ìŠ¤ì½”ì–´"
        echo ""
        echo "Environment Status:"
        echo "SUPABASE_URL: $([[ -n "$SUPABASE_URL" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "SUPABASE_SERVICE_ROLE: $([[ -n "$SUPABASE_SERVICE_ROLE" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "THESPORTSDB_API_KEY: $([[ -n "$THESPORTSDB_API_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "HIGHLIGHTLY_API_KEY: $([[ -n "$HIGHLIGHTLY_API_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo ""
        
        # 3-API í†µí•© ì‹œìŠ¤í…œ ì‹¤í–‰
        if npx tsx scripts/triple-api-comprehensive-migration.ts; then
          echo "âœ… 3-API í†µí•© ì¼ì¼ ë™ê¸°í™” ì„±ê³µ"
          echo "ğŸ“ˆ Data Quality: K League (ì •í™•ì„±) + TheSportsDB (í’ë¶€í•¨) + Highlightly (ì‹¤ì‹œê°„ì„±)"
        else
          echo "âŒ 3-API í†µí•© ì¼ì¼ ë™ê¸°í™” ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: Weekly 3-API Full Integration Sync
      if: github.event.schedule == '0 3 * * 1'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ ì£¼ê°„ 3-API í†µí•© ì „ì²´ ë™ê¸°í™” ì‹œì‘..."
        echo "ğŸ”„ Comprehensive sync across all 3 APIs for data consistency"
        echo "ğŸ“Š Full Integration Strategy:"
        echo "  â†ªï¸ Phase 1: K League Official (íŒ€, ê²½ê¸°, ìˆœìœ„ ì „ì²´ ê°±ì‹ )"
        echo "  â†ªï¸ Phase 2: TheSportsDB Premium (ë©”íƒ€ë°ì´í„° ë³´ê°•)"
        echo "  â†ªï¸ Phase 3: Highlightly (ì‹¤ì‹œê°„ ë°ì´í„° ê²€ì¦)"
        echo "  â†ªï¸ Phase 4: Data Quality & Consistency Validation"
        echo ""
        
        # ì „ì²´ 3-API í†µí•© ì‹¤í–‰
        if npx tsx scripts/triple-api-comprehensive-migration.ts --full-sync; then
          echo "âœ… 3-API í†µí•© ì£¼ê°„ ì „ì²´ ë™ê¸°í™” ì„±ê³µ"
          echo "ğŸ¯ Complete 3-API ecosystem synchronized"
        else
          echo "âŒ 3-API í†µí•© ì£¼ê°„ ì „ì²´ ë™ê¸°í™” ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: Live Match Data Sync (Weekend Peak Hours)
      if: github.event.schedule == '0 10-15 * * 6,0'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "âš¡ ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë§¤ì¹˜ ë°ì´í„° ë™ê¸°í™” ì‹œì‘..."
        echo "ğŸŸï¸ Weekend Peak Hours: ì£¼ë§ ê²½ê¸° ì¤‘ ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸"
        echo "ğŸ“¡ Using Highlightly API for real-time match events"
        echo ""
        
        # Highlightly ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”
        if npx tsx scripts/highlightly-live-sync.ts; then
          echo "âœ… ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë°ì´í„° ë™ê¸°í™” ì„±ê³µ"
        else
          echo "âš ï¸ ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨ (non-critical)"
        fi
        
    - name: Manual 3-API Integration
      if: github.event_name == 'workflow_dispatch'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸ¯ ìˆ˜ë™ 3-API í†µí•© ì‹œìŠ¤í…œ ì‹¤í–‰..."
        echo "ğŸš€ SUCCESS: API-Football â†’ 3-API í†µí•© ì‹œìŠ¤í…œ ì™„ì „ ì „í™˜"
        echo ""
        echo "3-API Integration Status:"
        echo "SUPABASE_URL: $([[ -n "$SUPABASE_URL" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "SUPABASE_SERVICE_ROLE: $([[ -n "$SUPABASE_SERVICE_ROLE" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "K League Official API: âœ… Free public API (ê³µì‹ ë°ì´í„°)"
        echo "THESPORTSDB_API_KEY: $([[ -n "$THESPORTSDB_API_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo "HIGHLIGHTLY_API_KEY: $([[ -n "$HIGHLIGHTLY_API_KEY" ]] && echo "âœ… Set" || echo "âŒ Missing")"
        echo ""
        
        # ì „ì²´ 3-API ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        echo "ğŸ§ª Testing 3-API Integration System..."
        if npx tsx scripts/test-triple-api-system.ts; then
          echo "âœ… 3-API ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í†µê³¼"
        else
          echo "âŒ 3-API ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
        
        # ì‹¤ì œ ë°ì´í„° ë™ê¸°í™” ì‹¤í–‰
        if npx tsx scripts/triple-api-comprehensive-migration.ts; then
          echo "âœ… 3-API í†µí•© ìˆ˜ë™ ì‹¤í–‰ ì„±ê³µ"
          echo "ğŸ‰ 3-API í†µí•© ì‹œìŠ¤í…œ ì™„ì „ ê°€ë™"
        else
          echo "âŒ 3-API í†µí•© ìˆ˜ë™ ì‹¤í–‰ ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: Data Quality & Integration Validation
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        NODE_ENV: production
      run: |
        echo "ğŸ” 3-API í†µí•© ë°ì´í„° í’ˆì§ˆ ê²€ì¦ ì‹œì‘..."
        echo "ğŸ“Š Validating data consistency across all 3 APIs"
        echo ""
        
        # ë°ì´í„° í’ˆì§ˆ ê²€ì¦
        if npx tsx scripts/final-verification.ts; then
          echo "âœ… ë°ì´í„° í’ˆì§ˆ ê²€ì¦ í†µê³¼"
        else
          echo "âš ï¸ ë°ì´í„° í’ˆì§ˆ ê²€ì¦ ê²½ê³  (non-critical, ê³„ì† ì§„í–‰)"
        fi
        
        # 3-API í†µí•© ìƒíƒœ ê²€ì¦
        if npx tsx scripts/validate-triple-api-integration.ts; then
          echo "âœ… 3-API í†µí•© ìƒíƒœ ê²€ì¦ í†µê³¼"
        else
          echo "âš ï¸ 3-API í†µí•© ìƒíƒœ ê²€ì¦ ê²½ê³  (non-critical)"
        fi
        
    - name: Workflow Summary (3-API Integration)
      if: always()
      run: |
        echo "ğŸ‰ 3-API í†µí•© ì›Œí¬í”Œë¡œìš° ì™„ë£Œ"
        echo ""
        echo "ğŸ“ˆ Integration Summary:"
        echo "âœ… Status: API-Football â†’ 3-API í†µí•© ì‹œìŠ¤í…œ ì „í™˜ ì™„ë£Œ"
        echo "ğŸ‡°ğŸ‡· K League Official API: ì •í™•í•œ ê³µì‹ ë°ì´í„° ì œê³µ"
        echo "ğŸŸï¸ TheSportsDB Premium: í’ë¶€í•œ ë©”íƒ€ë°ì´í„° ë° ì´ë¯¸ì§€"
        echo "âš¡ Highlightly API: ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë§¤ì¹˜ ë°ì´í„°"
        echo "ğŸ’° Cost Optimization: 85% ë¹„ìš© ì ˆê° ë‹¬ì„±"
        echo "ğŸ”„ Data Reliability: 3ì¤‘ ë°±ì—… ì‹œìŠ¤í…œìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´"
        echo ""
        echo "ğŸ“… Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "ğŸ¯ Trigger: ${{ github.event_name }}"
        echo "ğŸ“‚ Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo ""
        echo "ğŸš€ Next Generation K League Data Platform Ready!"