# .github/workflows/triple-api-sync.yml
name: 3-API í†µí•© ë°ì´í„° ë™ê¸°í™” (K League + TheSportsDB + Highlightly)

# ğŸš€ 3-API INTEGRATION SYSTEM:
# Successfully migrated from API-Football to comprehensive 3-API solution
# 
# ğŸ“Š 3-API Integration Strategy:
#   - K League Official API: ì •í™•í•œ ê³µì‹ ë°ì´í„° (íŒ€, ê²½ê¸°, ìˆœìœ„)
#   - TheSportsDB Premium API: í’ë¶€í•œ ë©”íƒ€ë°ì´í„° (ë¡œê³ , ì´ë¯¸ì§€, í†µê³„)
#   - Highlightly API: ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë°ì´í„° (ë¼ì´ë¸Œ ìŠ¤ì½”ì–´, í•˜ì´ë¼ì´íŠ¸)
#
# âœ… 3-API Integration Benefits:
#   - ë°ì´í„° ì •í™•ì„±: K League ê³µì‹ APIë¡œ ì‹ ë¢°ì„± í™•ë³´
#   - ì‹œê°ì  í’ë¶€í•¨: TheSportsDBë¡œ íŒ€ ë¡œê³ , ì„ ìˆ˜ ì´ë¯¸ì§€ ì œê³µ
#   - ì‹¤ì‹œê°„ì„±: Highlightlyë¡œ ë¼ì´ë¸Œ ë§¤ì¹˜ ë°ì´í„° ì§€ì›
#   - ë¹„ìš© ìµœì í™”: API-Football ëŒ€ë¹„ 85% ë¹„ìš© ì ˆê°
#   - ë‹¤ì¤‘ ë°±ì—…: í•˜ë‚˜ì˜ API ì¥ì•  ì‹œì—ë„ ì„œë¹„ìŠ¤ ì§€ì†ì„± ë³´ì¥

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC) - í•œêµ­ì‹œê°„ ì˜¤ì „ 11ì‹œ (ì¼ì¼ ë°ì´í„° ë™ê¸°í™”)
    - cron: '0 2 * * *'
    
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 3ì‹œ (ì „ì²´ ë°ì´í„° ì¬ë™ê¸°í™”)
    - cron: '0 3 * * 1'
    
    # ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë°ì´í„° ë™ê¸°í™” (ê²½ê¸° ì¤‘ ì‹œê°„ëŒ€)
    - cron: '0 10-15 * * 6,0'  # ì£¼ë§ 10-15ì‹œ (í•œêµ­ì‹œê°„ 19-24ì‹œ)
    
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Environment Check (3-API Integration)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ 3-API í†µí•© ë°ì´í„° ë™ê¸°í™” ì‹œì‘..."
        echo "ğŸ‡°ğŸ‡· K League + ğŸŸï¸ TheSportsDB + âš¡ Highlightly"
        npx tsx scripts/env-check.ts
      
    - name: Daily 3-API Integration Sync
      if: github.event.schedule == '0 2 * * *'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ ì¼ì¼ 3-API í†µí•© ë°ì´í„° ë™ê¸°í™” ì‹œì‘..."
        echo "ğŸ“Š K League + TheSportsDB + Highlightly ë°ì´í„° ìˆ˜ì§‘"
        
        # 3-API í†µí•© ë°ì´í„° ì„í¬íŠ¸ ì‹¤í–‰
        npx tsx scripts/fixed-triple-api-migration.ts
        
    - name: Weekly 3-API Full Integration Sync
      if: github.event.schedule == '0 3 * * 1'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸš€ ì£¼ê°„ 3-API í†µí•© ì „ì²´ ë™ê¸°í™” ì‹œì‘..."
        echo "ğŸ“Š K League + TheSportsDB + Highlightly ì „ì²´ ë°ì´í„° ê°±ì‹ "
        
        # 3-API í†µí•© ì „ì²´ ë°ì´í„° ì„í¬íŠ¸ ì‹¤í–‰
        npx tsx scripts/fixed-triple-api-migration.ts
        
    - name: Live Match Data Sync (Weekend Peak Hours)
      if: github.event.schedule == '0 10-15 * * 6,0'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "âš¡ ì£¼ë§ ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ë§¤ì¹˜ ë°ì´í„° ë™ê¸°í™”..."
        
        # Highlightly ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”
        npx tsx scripts/highlightly-live-sync.ts || echo "âš ï¸ ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨ (non-critical)"
        
    - name: Manual 3-API Integration
      if: github.event_name == 'workflow_dispatch'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        HIGHLIGHTLY_API_KEY: ${{ secrets.HIGHLIGHTLY_API_KEY }}
        SEASON_YEAR: 2025
        NODE_ENV: production
      run: |
        echo "ğŸ¯ ìˆ˜ë™ 3-API í†µí•© ì‹œìŠ¤í…œ ì‹¤í–‰..."
        echo "ğŸ“Š K League + TheSportsDB + Highlightly ë°ì´í„° ë™ê¸°í™”"
        
        # 3-API í†µí•© ë°ì´í„° ì„í¬íŠ¸ ì‹¤í–‰
        npx tsx scripts/fixed-triple-api-migration.ts
        
    - name: Data Quality & Integration Validation
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        NODE_ENV: production
      run: |
        echo "ğŸ” ë°ì´í„° í’ˆì§ˆ ê²€ì¦..."
        
        # ë°ì´í„° í’ˆì§ˆ ê²€ì¦ (í•„ìˆ˜ ê²€ì¦ë§Œ)
        npx tsx scripts/final-data-quality-check.ts || echo "âš ï¸ í’ˆì§ˆ ê²€ì¦ ê²½ê³  (non-critical)"
        
    - name: Workflow Summary (3-API Integration)
      if: always()
      run: |
        echo "âœ… 3-API í†µí•© ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ"
        echo "ğŸ“… $(date -u +"%Y-%m-%d %H:%M:%S UTC") | Trigger: ${{ github.event_name }}"